# Mask-Based Loss å®ç°è¯´æ˜

## æ¦‚è¿°

æ ¹æ®ç”¨æˆ·å»ºè®®ï¼Œå®ç°äº†åŸºäºmaskçš„æŸå¤±å‡½æ•°æ¥ç›´æ¥æƒ©ç½šå’Œæ¶ˆé™¤maskå¤–çš„å‘æ•£Gaussianç‚¹ã€‚è¿™æ˜¯ä¸€ç§ä¸gradient multiplierè°ƒä¼˜ä¸åŒçš„çº¦æŸæ–¹æ³•ã€‚

## é—®é¢˜èƒŒæ™¯

### ä¹‹å‰å°è¯•çš„æ–¹æ¡ˆåŠé—®é¢˜

1. **åŸå§‹æ··åˆæ¢¯åº¦æ–¹æ¡ˆ** (100Ã—/50Ã—):
   - æ•ˆæœæœ‰æ‰€æ”¹å–„ï¼Œä½†ä»æœ‰å°‘é‡å‘æ•£ç‚¹
   - ç”¨æˆ·å¸Œæœ›æœ‰æ›´å¼ºçš„çº¦æŸ

2. **å¢å¼ºæ¢¯åº¦å€æ•°** (200Ã—/100Ã—):
   - é—®é¢˜ï¼šmax gradientè¾¾åˆ°32.18ï¼Œå¯¼è‡´æ•°å€¼ä¸ç¨³å®š
   - ç»“æœï¼šiteration 2600æ—¶æ¢¯åº¦æ¶ˆå¤±
   - åæ ‡å˜æ¢çˆ†ç‚¸ï¼šTranslation=[-0.337, -0.512, 0.859]

3. **å¹³è¡¡å‚æ•°æ–¹æ¡ˆ** (150Ã—/75Ã— + é™ä½LR):
   - é—®é¢˜ï¼šé™ä½å­¦ä¹ ç‡åå‘æ•£æ›´ä¸¥é‡
   - ç”¨æˆ·åé¦ˆï¼šæ•ˆæœä¸å¦‚åŸå§‹ç‰ˆæœ¬
   - ç»“è®ºï¼šå‚æ•°è°ƒä¼˜æ–¹æ³•é‡åˆ°ç“¶é¢ˆ

### æ–°æ–¹æ¡ˆï¼šMask-Based Loss

ç”¨æˆ·æå‡ºçš„æ ¸å¿ƒæ€è·¯ï¼š
> "åˆ©ç”¨ä¹‹å‰çš„maskæ¥æ¶ˆé™¤å‰©ä½™çš„ä¸å¤šçš„ç‚¹äº‘ï¼Œåœ¨lossä¸­åˆ©ç”¨`mask*(gt-pred) +/- (1-mask)*[å‰©ä½™çš„ç‚¹ä¸­ä¸æ˜¯æœ‰æ•ˆé«˜æ–¯ç‚¹]`è¿™ç§lossçš„æ–¹å¼æ¥å»é™¤é¢å¤–çš„é«˜æ–¯ç‚¹"

## å®ç°æ–¹æ³•

### ä¿®æ”¹ä½ç½®

æ–‡ä»¶ï¼š`/home/wang/project/gaussian-splatting-gai/train.py`
è¡Œæ•°ï¼š137-174 (æ·±åº¦lossè®¡ç®—éƒ¨åˆ†)

### æ ¸å¿ƒä»£ç 

```python
# æ ¸å¿ƒæŸå¤±ï¼šmaskå†…çš„æ·±åº¦å¯¹é½
inside_mask_loss = torch.abs((invDepth - mono_invdepth) * depth_mask).sum() / denom

# é¢å¤–çº¦æŸï¼šæƒ©ç½šmaskå¤–çš„æ¸²æŸ“æ·±åº¦
# ç›®çš„ï¼šå¼ºåˆ¶é«˜æ–¯ç‚¹åœ¨maskå¤–çš„è´¡çŒ®ä¸º0ï¼Œæ¶ˆé™¤å‘æ•£ç‚¹
invalid = (depth_mask <= 0.5).float()
invalid_denom = invalid.sum().clamp(min=1.0)
outside_mask_penalty = torch.abs(invDepth * invalid).sum() / invalid_denom

# æ··åˆæŸå¤±ï¼šä¸»è¦çº¦æŸ + maskå¤–æƒ©ç½š
lambda_outside = 0.5  # å¯è°ƒèŠ‚å‚æ•°ï¼šè¶Šå¤§å¯¹maskå¤–çº¦æŸè¶Šå¼º
Ll1depth_pure = inside_mask_loss + lambda_outside * outside_mask_penalty
```

### å·¥ä½œåŸç†

#### 1. Lossç»„æˆ

**åŸå§‹loss**ï¼š
```
L_depth = Î£ |rendered_invdepth - gt_invdepth| * mask / N_valid
```
- åªçº¦æŸmaskå†…çš„æ·±åº¦å¯¹é½
- maskå¤–çš„åŒºåŸŸæ— çº¦æŸï¼ŒGaussianç‚¹å¯ä»¥è‡ªç”±è´¡çŒ®æ·±åº¦

**æ–°çš„mask-based loss**ï¼š
```
L_depth = L_inside + Î» * L_outside

å…¶ä¸­ï¼š
L_inside = Î£ |rendered_invdepth - gt_invdepth| * mask / N_valid
L_outside = Î£ |rendered_invdepth| * (1-mask) / N_invalid
```

#### 2. ç›´è§‚ç†è§£

æƒ³è±¡ä½ åœ¨æ¸…ç†ä¸€ä¸ªæˆ¿é—´ï¼š

**åŸå§‹æ–¹æ¡ˆ**ï¼ˆåªç”¨gradient multipliersï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ‰æ•ˆåŒºåŸŸ (maskå†…)                  â”‚
â”‚   ğŸª‘ ğŸª‘ ğŸª‘                         â”‚
â”‚   ğŸ’º ğŸ’º ğŸ’º                         â”‚
â”‚                                    â”‚
â”‚ æ— æ•ˆåŒºåŸŸ (maskå¤–)                  â”‚
â”‚   âŒ âŒ      â† å‘æ•£çš„ç‚¹            â”‚
â”‚        âŒ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
- åªå‘Šè¯‰æ¨¡å‹"è®©maskå†…çš„æ¤…å­å¯¹é½æ·±åº¦"
- æ²¡æœ‰æ˜ç¡®å‘Šè¯‰æ¨¡å‹"maskå¤–ä¸åº”è¯¥æœ‰ä¸œè¥¿"
- å‘æ•£ç‚¹é€šè¿‡å±€éƒ¨æ¢¯åº¦ä¼˜åŒ–ä»å¯èƒ½å­˜åœ¨
```

**Mask-based lossæ–¹æ¡ˆ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ‰æ•ˆåŒºåŸŸ (maskå†…)                  â”‚
â”‚   ğŸª‘ ğŸª‘ ğŸª‘                         â”‚
â”‚   ğŸ’º ğŸ’º ğŸ’º                         â”‚
â”‚ âœ“ çº¦æŸ1ï¼šå¯¹é½æ·±åº¦                 â”‚
â”‚                                    â”‚
â”‚ æ— æ•ˆåŒºåŸŸ (maskå¤–)                  â”‚
â”‚   [ç©º]  â† âœ“ çº¦æŸ2ï¼šæƒ©ç½šä»»ä½•æ¸²æŸ“    â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
- çº¦æŸ1 (L_inside)ï¼šç¡®ä¿maskå†…çš„æ·±åº¦æ­£ç¡®
- çº¦æŸ2 (L_outside)ï¼šç›´æ¥æƒ©ç½šmaskå¤–çš„ä»»ä½•æ¸²æŸ“
- åŒé‡çº¦æŸï¼Œç›´æ¥æ¶ˆé™¤å‘æ•£ç‚¹
```

#### 3. æ¢¯åº¦æµåŠ¨æœºåˆ¶

**Forward Pass**:
```
gaussians (xyz, opacity, scale, rotation)
    â†“
render (alpha blending)
    â†“
rendered_invdepth = Î£ (1/z_i) * alpha_i * T_i
    â†“
L_inside: åªåœ¨maskå†…è®¡ç®— |rendered - gt|
L_outside: æƒ©ç½šmaskå¤–çš„ä»»ä½•renderedå€¼
    â†“
L_total = L_inside + 0.5 * L_outside
```

**Backward Pass** (maskå¤–åŒºåŸŸ):
```
L_outside = Î£ |rendered_invdepth| * (1-mask) / N_invalid
    â†“
dL/d(rendered_invdepth) = sign(rendered_invdepth) * (1-mask) / N_invalid
    â†“
é€šè¿‡CUDA rasterizer backwardä¼ æ’­åˆ°Gaussianå‚æ•°
    â†“
dL/d(opacity): é™ä½maskå¤–Gaussiançš„ä¸é€æ˜åº¦
dL/d(xyz): å°†Gaussianæ¨å‘maskå†…ï¼ˆæˆ–é™ä½å…¶è´¡çŒ®ï¼‰
dL/d(scale): å‡å°maskå¤–Gaussiançš„å°ºåº¦
```

**å…³é”®æœºåˆ¶**ï¼š
- maskå¤–çš„ä»»ä½•æ¸²æŸ“æ·±åº¦éƒ½è¢«è§†ä¸º"é”™è¯¯"
- æ¢¯åº¦ä¼šåŒæ—¶ä½œç”¨äºopacityã€scaleã€xyz
- æœ€æœ‰æ•ˆçš„é™ä½L_outsideçš„æ–¹æ³•ï¼šé™ä½maskå¤–ç‚¹çš„opacity â†’ æœ€ç»ˆè¢«pruneæ‰

#### 4. ä¸Densificationçš„ååŒ

```
Training Loop:

Iteration N:
  1. Render depth
  2. Compute loss:
     - L_inside: é¼“åŠ±maskå†…ç‚¹å¯¹é½æ·±åº¦
     - L_outside: æƒ©ç½šmaskå¤–çš„ä»»ä½•æ¸²æŸ“
  3. Backward pass:
     - maskå†…çš„ç‚¹ï¼šæ”¶åˆ°3D+2Dæ··åˆæ¢¯åº¦ï¼ˆæ·±åº¦å¯¹é½ä¿¡å·ï¼‰
     - maskå¤–çš„ç‚¹ï¼šæ”¶åˆ°negativeæ¢¯åº¦ï¼ˆé™ä½opacity/scaleï¼‰
  4. Densification (æ¯100 iterations):
     - maskå†…æ¢¯åº¦é«˜çš„ç‚¹ï¼šclone/splitï¼ˆå› ä¸ºéœ€è¦æ›´å¥½çš„æ·±åº¦å¯¹é½ï¼‰
     - maskå¤–æ¢¯åº¦ä½çš„ç‚¹ï¼šä¸densify
  5. Pruning:
     - Low opacityç‚¹è¢«ç§»é™¤
     - maskå¤–çš„ç‚¹å› ä¸ºL_outsideé€æ¸é™ä½opacity â†’ è¢«prune
```

### å‚æ•°è¯´æ˜

#### lambda_outside = 0.5

```python
lambda_outside = 0.5  # å¯è°ƒèŠ‚å‚æ•°ï¼šè¶Šå¤§å¯¹maskå¤–çº¦æŸè¶Šå¼º
Ll1depth_pure = inside_mask_loss + lambda_outside * outside_mask_penalty
```

**å«ä¹‰**ï¼š
- `lambda_outside = 0.5`: maskå¤–æƒ©ç½šçš„æƒé‡æ˜¯maskå†…æŸå¤±çš„50%
- ä¾‹å¦‚ï¼š
  - å¦‚æœ `inside_mask_loss = 0.001`
  - ä¸” `outside_mask_penalty = 0.002`
  - åˆ™ `Ll1depth_pure = 0.001 + 0.5 * 0.002 = 0.002`

**è°ƒä¼˜å»ºè®®**ï¼š

| lambda_outside | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|----------------|------|----------|
| 0.1 - 0.3 | è¾ƒå¼±çº¦æŸ | å½“maskå¤–å‘æ•£ç‚¹å¾ˆå°‘æ—¶ |
| **0.5** | **å¹³è¡¡** | **æ¨èé»˜è®¤å€¼** |
| 0.7 - 1.0 | å¼ºçº¦æŸ | å½“å‘æ•£ä¸¥é‡æ—¶ |
| > 1.0 | æå¼ºçº¦æŸ | å¯èƒ½è¿‡åº¦æŠ‘åˆ¶maskè¾¹ç¼˜çš„ç‚¹ |

**å¦‚ä½•é€‰æ‹©**ï¼š
1. å…ˆç”¨é»˜è®¤å€¼ `0.5` è®­ç»ƒ
2. è§‚å¯Ÿç»“æœï¼š
   - å¦‚æœä»æœ‰å‘æ•£ç‚¹ â†’ å¢å¤§åˆ° `0.7` æˆ– `1.0`
   - å¦‚æœmaskè¾¹ç¼˜çš„æœ‰æ•ˆç‚¹è¢«è¯¯ä¼¤ â†’ é™ä½åˆ° `0.3`
3. é€šè¿‡tensorboardç›‘æ§ `L_outside` çš„å€¼ï¼š
   - å¦‚æœ `L_outside` ä¸€ç›´å¾ˆé«˜ â†’ å¯èƒ½éœ€è¦å¢å¤§ `lambda_outside`
   - å¦‚æœ `L_outside` å¿«é€Ÿé™åˆ°æ¥è¿‘0 â†’ è¯´æ˜çº¦æŸæœ‰æ•ˆ

## ä¸ä¹‹å‰æ–¹æ¡ˆçš„å¯¹æ¯”

### æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | çº¦æŸæœºåˆ¶ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“æœ |
|------|----------|------|------|------|
| **åŸå§‹** (100Ã—/50Ã—) | æ··åˆæ¢¯åº¦ | ç¨³å®šè®­ç»ƒ | ä»æœ‰å°‘é‡å‘æ•£ç‚¹ | éƒ¨åˆ†æœ‰æ•ˆ |
| **å¢å¼ºå€æ•°** (200Ã—/100Ã—) | æ›´å¼ºæ¢¯åº¦ | åˆæœŸçº¦æŸå¼º | æ•°å€¼ä¸ç¨³å®šï¼Œæ¢¯åº¦æ¶ˆå¤± | å¤±è´¥ |
| **é™ä½LR** (150Ã—/75Ã—) | å¹³è¡¡æ¢¯åº¦+ç¨³å®šä¼˜åŒ– | æ— æ¢¯åº¦æ¶ˆå¤± | å‘æ•£æ›´ä¸¥é‡ | æ•ˆæœå·® |
| **Mask-based Loss** (æ–°) | ç›´æ¥æƒ©ç½šmaskå¤–æ¸²æŸ“ | æ˜ç¡®çº¦æŸï¼Œæœºåˆ¶æ¸…æ™° | éœ€è¦è°ƒå‚ `lambda_outside` | å¾…éªŒè¯ |

### æŠ€æœ¯å¯¹æ¯”

#### æ–¹æ³•1: Gradient Multiplier è°ƒä¼˜

**åŸç†**ï¼š
```
æ”¾å¤§æ¢¯åº¦ â†’ ç´¯ç§¯å€¼è¶…è¿‡é˜ˆå€¼ â†’ è§¦å‘densification/prune
```

**é—®é¢˜**ï¼š
- é—´æ¥çº¦æŸï¼šä¾èµ–æ¢¯åº¦ç´¯ç§¯ â†’ densification â†’ pruneçš„é“¾æ¡
- å‚æ•°æ•æ„Ÿï¼šå€æ•°å¤ªå¤§å¯¼è‡´æ•°å€¼ä¸ç¨³å®šï¼Œå¤ªå°çº¦æŸä¸è¶³
- å­¦ä¹ ç‡å†²çªï¼šé«˜å€æ•°éœ€è¦ä½LRï¼Œä½†ä½LRåˆå¯¼è‡´æ›´å¤šå‘æ•£

#### æ–¹æ³•2: Mask-Based Loss (æ–°æ–¹æ¡ˆ)

**åŸç†**ï¼š
```
ç›´æ¥æƒ©ç½šmaskå¤–çš„æ¸²æŸ“ â†’ é™ä½maskå¤–ç‚¹çš„opacity â†’ è‡ªç„¶è¢«prune
```

**ä¼˜åŠ¿**ï¼š
- ç›´æ¥çº¦æŸï¼šåœ¨losså±‚é¢æ˜ç¡®å®šä¹‰"maskå¤–ä¸åº”è¯¥æœ‰æ¸²æŸ“"
- æ¢¯åº¦æ¸…æ™°ï¼šmaskå¤–çš„ç‚¹æ”¶åˆ°æ˜ç¡®çš„negativeä¿¡å·
- å‚æ•°è§£è€¦ï¼šå¯ä»¥ä¿æŒåŸæœ‰çš„gradient multipliers (100Ã—/50Ã—)ï¼Œåªéœ€è°ƒèŠ‚ `lambda_outside`

## å®éªŒå»ºè®®

### æµ‹è¯•1: é»˜è®¤å‚æ•°

```bash
python train.py -s data --depths depth --eval \
    --iterations 3000 -m output/test_mask_loss_default
```

**é…ç½®**ï¼š
- `lambda_outside = 0.5`
- Gradient multipliers: 100Ã— (3D), 50Ã— (2D)
- Learning rates: åŸå§‹å€¼ (translation=0.01, rotation=0.001, scale=0.001)

**é¢„æœŸç»“æœ**ï¼š
- Lossåº”è¯¥åŒ…å«ä¸¤éƒ¨åˆ†ï¼šinside_mask_loss + outside_mask_penalty
- è®­ç»ƒè¿‡ç¨‹ä¸­ `outside_mask_penalty` åº”è¯¥é€æ¸ä¸‹é™
- maskå¤–çš„å‘æ•£ç‚¹åº”è¯¥åœ¨åæœŸè¢«pruneæ‰

### æµ‹è¯•2: å¼ºçº¦æŸ

å¦‚æœé»˜è®¤å‚æ•°ä»æœ‰å‘æ•£ï¼Œå°è¯•ï¼š

```python
# åœ¨ train.py line 167 ä¿®æ”¹
lambda_outside = 1.0  # ä»0.5å¢åŠ åˆ°1.0
```

### æµ‹è¯•3: ä¸åŸå§‹æ–¹æ¡ˆå¯¹æ¯”

åŒæ—¶è¿è¡Œä¸¤ä¸ªå®éªŒï¼š

```bash
# ç»ˆç«¯1: Mask-based loss (æ–°æ–¹æ¡ˆ)
python train.py -s data --depths depth --eval \
    --iterations 3000 -m output/test_mask_loss

# ç»ˆç«¯2: åŸå§‹æ–¹æ¡ˆ (ä½œä¸ºå¯¹ç…§)
git stash  # æš‚å­˜mask-based lossä¿®æ”¹
python train.py -s data --depths depth --eval \
    --iterations 3000 -m output/test_original
git stash pop  # æ¢å¤mask-based lossä¿®æ”¹
```

å¯¹æ¯”æŒ‡æ ‡ï¼š
1. **Lossæ›²çº¿**ï¼š
   - åŸå§‹ï¼šåªæœ‰ `L_inside`
   - æ–°æ–¹æ¡ˆï¼š`L_inside + 0.5*L_outside`
   - æœŸæœ›ï¼šæ–°æ–¹æ¡ˆçš„ `L_outside` é€æ¸é™åˆ°æ¥è¿‘0

2. **ç‚¹äº‘æ•°é‡**ï¼š
   - è§‚å¯Ÿæœ€ç»ˆç‚¹æ•°å’Œdensificationç»Ÿè®¡
   - æœŸæœ›ï¼šæ–°æ–¹æ¡ˆçš„ç‚¹äº‘æ›´é›†ä¸­ï¼Œmaskå¤–ç‚¹æ›´å°‘

3. **æ¢¯åº¦ç»Ÿè®¡**ï¼š
   - å¯¹æ¯” `[Densify] Grad stats` è¾“å‡º
   - æœŸæœ›ï¼šæ–°æ–¹æ¡ˆçš„æ¢¯åº¦åˆ†å¸ƒæ›´å¥åº·

4. **è§†è§‰æ•ˆæœ**ï¼š
   - æ¸²æŸ“ç‚¹äº‘ï¼Œè§‚å¯Ÿmaskå¤–æ˜¯å¦æœ‰å‘æ•£ç‚¹
   - æœŸæœ›ï¼šæ–°æ–¹æ¡ˆçš„ç‚¹äº‘ä¸¥æ ¼é™åˆ¶åœ¨maskå†…

## è°ƒè¯•å»ºè®®

### 1. ç›‘æ§ outside_mask_penalty

æ·»åŠ ç›‘æ§ä»£ç ï¼ˆå¯é€‰ï¼‰ï¼š

```python
# åœ¨ train.py line 170 ä¹‹åæ·»åŠ 
if iteration % 100 == 0:
    print(f"[DEBUG] Iteration {iteration}: "
          f"L_inside={inside_mask_loss.item():.6f}, "
          f"L_outside={outside_mask_penalty.item():.6f}")
```

**æœŸæœ›è¾“å‡º**ï¼š
```
[DEBUG] Iteration 100: L_inside=0.005234, L_outside=0.002341
[DEBUG] Iteration 500: L_inside=0.000923, L_outside=0.000845
[DEBUG] Iteration 1000: L_inside=0.000234, L_outside=0.000123
[DEBUG] Iteration 3000: L_inside=0.000012, L_outside=0.000003
```

**åˆ†æ**ï¼š
- `L_outside` åº”è¯¥æŒç»­ä¸‹é™
- å¦‚æœ `L_outside` ä¸é™ â†’ å¢å¤§ `lambda_outside`
- å¦‚æœ `L_inside` ä¸é™ â†’ å¯èƒ½maskè´¨é‡æœ‰é—®é¢˜

### 2. å¯è§†åŒ–maskå¤–çš„æ¸²æŸ“

åœ¨è®­ç»ƒä¸­æœŸä¿å­˜æ¸²æŸ“ç»“æœï¼š

```python
# å¯é€‰ï¼šåœ¨ train.py iteration 1500 æ—¶ä¿å­˜maskå¤–åŒºåŸŸçš„æ¸²æŸ“
if iteration == 1500:
    with torch.no_grad():
        outside_render = invDepth * invalid
        import torchvision
        torchvision.utils.save_image(
            outside_render.unsqueeze(0),
            f"{scene.model_path}/outside_mask_iter{iteration}.png"
        )
```

**æœŸæœ›**ï¼š
- Early iterations: maskå¤–æœ‰æ˜æ˜¾æ¸²æŸ“ï¼ˆç™½è‰²åŒºåŸŸï¼‰
- Late iterations: maskå¤–æ¥è¿‘å…¨é»‘ï¼ˆæ— æ¸²æŸ“ï¼‰

### 3. ç»Ÿè®¡maskå¤–ç‚¹çš„æ•°é‡

åœ¨densificationåç»Ÿè®¡ï¼š

```python
# å¯é€‰ï¼šæ·»åŠ åˆ° train.py densificationéƒ¨åˆ†
if iteration % 500 == 0:
    with torch.no_grad():
        # ç®€åŒ–ç‰ˆæœ¬ï¼šç»Ÿè®¡æœ‰å¤šå°‘ç‚¹åœ¨maskå¤–è´¡çŒ®æ˜¾è‘—
        outside_contribution = (invDepth * invalid).sum()
        print(f"[Mask Stats] Iteration {iteration}: "
              f"Outside contribution = {outside_contribution.item():.6f}")
```

## åŸç†æ·±å…¥åˆ†æ

### ä¸ºä»€ä¹ˆç›´æ¥æƒ©ç½šæ¸²æŸ“æ·±åº¦æœ‰æ•ˆï¼Ÿ

#### 1. æ¸²æŸ“æ–¹ç¨‹

3D Gaussian Splattingçš„æ·±åº¦æ¸²æŸ“ï¼š
```
rendered_invdepth(pixel) = Î£áµ¢ (1/záµ¢) * Î±áµ¢ * Táµ¢

å…¶ä¸­ï¼š
- záµ¢: ç¬¬iä¸ªGaussianåˆ°ç›¸æœºçš„æ·±åº¦
- Î±áµ¢: ç¬¬iä¸ªGaussianåœ¨è¯¥åƒç´ çš„alphaå€¼ï¼ˆç”±opacityå’Œ2D Gaussianå†³å®šï¼‰
- Táµ¢: é€å°„ç‡ = Î â±¼â‚â±¼<áµ¢â‚ (1 - Î±â±¼)
```

#### 2. Maskå¤–çš„æ¸²æŸ“ = Gaussianè´¡çŒ®çš„è¯æ®

å¦‚æœ `rendered_invdepth > 0` åœ¨maskå¤–ï¼š
- è¯´æ˜è‡³å°‘æœ‰ä¸€ä¸ªGaussianåœ¨è¯¥åƒç´ æœ‰éé›¶çš„ `Î±áµ¢ * Táµ¢`
- è¿™ä¸ªGaussianå¯èƒ½ï¼š
  1. ä¸­å¿ƒåœ¨maskå¤– â†’ å‘æ•£ç‚¹
  2. ä¸­å¿ƒåœ¨maskå†…ï¼Œä½†scaleå¤ªå¤§ â†’ è¾¹ç¼˜æº¢å‡º
  3. opacityå¤ªé«˜ â†’ å½±å“èŒƒå›´è¿‡å¤§

#### 3. æƒ©ç½šæœºåˆ¶çš„ä½œç”¨è·¯å¾„

**Losså®šä¹‰**ï¼š
```python
L_outside = Î£_pixels_in_invalid_region |rendered_invdepth|
```

**æ¢¯åº¦åå‘ä¼ æ’­**ï¼š
```
dL_outside / d(rendered_invdepth) = sign(rendered_invdepth)  # å¦‚æœ rendered > 0

å¯¹äºè´¡çŒ®äº†è¯¥åƒç´ çš„ç¬¬iä¸ªGaussian:
dL_outside / dÎ±áµ¢ = (1/záµ¢) * Táµ¢ * sign(rendered)  # æ€»æ˜¯æ­£çš„

è¿›ä¸€æ­¥åˆ†è§£ Î±áµ¢ = opacity_i * Gaussian2D_i:
dL_outside / d(opacity_i) > 0  â†’ æ¢¯åº¦ä¸‹é™ â†’ opacityå‡å°
dL_outside / d(scale_i) > 0    â†’ æ¢¯åº¦ä¸‹é™ â†’ scaleå‡å°
dL_outside / d(xyz_i) â†’ æ¨å‘maskå†…ï¼ˆæˆ–å‡å°å…¶2D Gaussiançš„è´¡çŒ®ï¼‰
```

**ç»“æœ**ï¼š
- **çŸ­æœŸ**ï¼šé™ä½maskå¤–Gaussiançš„opacityå’Œscale
- **ä¸­æœŸ**ï¼šOpacityä½çš„Gaussianåœ¨pruningæ—¶è¢«ç§»é™¤
- **é•¿æœŸ**ï¼šmaskå¤–æ²¡æœ‰Gaussianè´¡çŒ® â†’ `L_outside â‰ˆ 0`

### ä¸Densificationçš„äº¤äº’

#### Scenario 1: æ­£å¸¸æƒ…å†µ

```
Iteration 500:
  - maskå†…çš„ç‚¹ï¼šæ”¶åˆ°æ·±åº¦å¯¹é½çš„3D/2Dæ¢¯åº¦ â†’ æ¢¯åº¦ç´¯ç§¯é«˜ â†’ è¢«densify
  - maskå¤–çš„ç‚¹ï¼šæ”¶åˆ°L_outsideçš„negativeæ¢¯åº¦ â†’ opacityé™ä½ â†’ æ¢¯åº¦ç´¯ç§¯ä½ â†’ ä¸densify

Iteration 1000:
  - maskå†…ï¼šæŒç»­densifyï¼Œå¢åŠ ç‚¹æ•°ï¼Œæé«˜æ·±åº¦ç²¾åº¦
  - maskå¤–ï¼šæŒç»­é™ä½opacity â†’ åœ¨pruningæ—¶è¢«ç§»é™¤

Result:
  âœ“ ç‚¹äº‘é›†ä¸­åœ¨maskå†…
  âœ“ æ— å‘æ•£ç‚¹
```

#### Scenario 2: è¾¹ç¼˜æƒ…å†µ

```
é—®é¢˜ï¼šmaskè¾¹ç¼˜çš„Gaussianå¯èƒ½éƒ¨åˆ†åœ¨maskå†…ï¼Œéƒ¨åˆ†åœ¨maskå¤–

è§£å†³ï¼š
  - L_inside: é¼“åŠ±maskå†…éƒ¨åˆ†å¯¹é½æ·±åº¦ï¼ˆpositive gradient on opacityï¼‰
  - L_outside: æƒ©ç½šmaskå¤–éƒ¨åˆ†ï¼ˆnegative gradient on opacityï¼‰
  - å¹³è¡¡ï¼šå¦‚æœè¯¥Gaussianä¸»è¦åœ¨maskå†… â†’ L_insideä¸»å¯¼ â†’ ä¿ç•™
          å¦‚æœè¯¥Gaussianä¸»è¦åœ¨maskå¤– â†’ L_outsideä¸»å¯¼ â†’ ç§»é™¤

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ lambda_outside çš„é€‰æ‹©å¾ˆé‡è¦ï¼š
  - å¤ªå¤§ï¼šå¯èƒ½è¯¯ä¼¤è¾¹ç¼˜çš„æœ‰æ•ˆGaussian
  - å¤ªå°ï¼šå¯¹å‘æ•£ç‚¹çš„æŠ‘åˆ¶ä¸è¶³
```

## æ€»ç»“

### æ ¸å¿ƒæ€æƒ³

**ç”¨æˆ·çš„åŸå§‹å»ºè®®**ï¼š
> "åˆ©ç”¨maskæ¥æ¶ˆé™¤å‰©ä½™çš„ç‚¹äº‘ï¼Œç”¨ `mask*(gt-pred) + (1-mask)*[æƒ©ç½šé¡¹]` çš„æ–¹å¼"

**å®ç°æ˜ å°„**ï¼š
```
mask*(gt-pred)     â†’  L_inside = |rendered - gt| * mask
(1-mask)*[æƒ©ç½šé¡¹]  â†’  L_outside = |rendered| * (1-mask)
```

### æŠ€æœ¯ä¼˜åŠ¿

1. **ç›´æ¥çº¦æŸ**ï¼šåœ¨losså±‚é¢æ˜ç¡®å®šä¹‰"maskå¤–ä¸åº”è¯¥æœ‰æ¸²æŸ“"
2. **æ¢¯åº¦æ¸…æ™°**ï¼šmaskå¤–çš„ç‚¹æ”¶åˆ°æ˜ç¡®çš„é™ä½opacityçš„ä¿¡å·
3. **è‡ªåŠ¨æ¸…ç†**ï¼šä½opacityç‚¹è‡ªç„¶åœ¨pruningæ—¶è¢«ç§»é™¤
4. **å‚æ•°è§£è€¦**ï¼šä¸ä¾èµ–gradient multiplierå’Œlearning rateçš„å¾®å¦™å¹³è¡¡

### ä¸ä¹‹å‰æ–¹æ¡ˆçš„äº’è¡¥

- **Hybrid Gradients (100Ã—/50Ã—)**: æä¾›maskå†…çš„æ·±åº¦å¯¹é½ä¿¡å·
- **Coordinate Transform**: å…¨å±€åˆšä½“çº¦æŸï¼Œé˜²æ­¢æ•´ä½“ç»“æ„å´©å¡Œ
- **Mask-based Loss (æ–°)**: ç›´æ¥æ¶ˆé™¤maskå¤–çš„å‘æ•£ç‚¹

ä¸‰è€…ç»“åˆï¼Œå½¢æˆå®Œæ•´çš„çº¦æŸä½“ç³»ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¨å±€çº¦æŸ (Coordinate Transform)        â”‚
â”‚  - ä¿æŒç‚¹äº‘æ•´ä½“ç»“æ„                     â”‚
â”‚  - å¯¹é½COLMAPå’Œæ·±åº¦å›¾åæ ‡ç³»            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±€éƒ¨çº¦æŸ (Hybrid Gradients)            â”‚
â”‚  - 3Dæ¢¯åº¦Ã—100: maskå†…æ·±åº¦å¯¹é½          â”‚
â”‚  - 2Dæ¢¯åº¦Ã—50: ç©ºé—´çº¦æŸ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾¹ç•Œçº¦æŸ (Mask-based Loss)             â”‚
â”‚  - L_inside: å¼ºåŒ–maskå†…å¯¹é½            â”‚
â”‚  - L_outside: æƒ©ç½šmaskå¤–æ¸²æŸ“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‹ä¸€æ­¥

1. **æµ‹è¯•éªŒè¯**ï¼šè¿è¡Œä¸Šè¿°æ¨èçš„å®éªŒ
2. **å‚æ•°è°ƒä¼˜**ï¼šæ ¹æ®ç»“æœè°ƒæ•´ `lambda_outside`
3. **æ•ˆæœå¯¹æ¯”**ï¼šä¸åŸå§‹æ–¹æ¡ˆå¯¹æ¯”ç‚¹äº‘è´¨é‡å’Œå‘æ•£æƒ…å†µ

---

*æ–‡æ¡£ç”Ÿæˆæ—¥æœŸ: 2025-10-13*
*å®éªŒä»£ç ç‰ˆæœ¬: gaussian-splatting-gai*
*ä¿®æ”¹æ–‡ä»¶: train.py lines 137-174*
